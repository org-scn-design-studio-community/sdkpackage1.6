/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2013 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.suite.ui.commons.TargetFilter");jQuery.sap.require("sap.suite.ui.commons.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.suite.ui.commons.TargetFilter",{metadata:{library:"sap.suite.ui.commons",properties:{"entitySet":{type:"string",group:"Misc",defaultValue:null},"measureColumnName":{type:"string",group:"Misc",defaultValue:null},"selectedColumnNames":{type:"string[]",group:"Misc",defaultValue:null}},aggregations:{"columns":{type:"sap.suite.ui.commons.TargetFilterColumn",multiple:true,singularName:"column"},"_dialog":{type:"sap.m.SelectDialog",multiple:false,visibility:"hidden"},"_countDisplay":{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},"_quad0":{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},"_quad1":{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},"_quad2":{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},"_quad3":{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{"selectedColumns":{type:"sap.suite.ui.commons.TargetFilterColumn",multiple:true,singularName:"selectedColumn"}},events:{"search":{},"filterChange":{}}}});sap.suite.ui.commons.TargetFilter.M_EVENTS={'search':'search','filterChange':'filterChange'};sap.m.ComboBox.extend("sap.suite.ui.commons.TargetFilterComboBox",{metadata:{properties:{popoverPlacement:{type:"sap.m.PlacementType",group:"Misc",defaultValue:sap.m.PlacementType.Bottom}}},_createPopover:function(){var p=new sap.m.Popover({showHeader:false,placement:this.getPopoverPlacement(),offsetX:0,offsetY:0,initialFocus:this,bounce:false});p.addStyleClass("TFComboBox");this._decoratePopover(p);return p;},renderer:function(r,c){sap.m.ComboBoxRenderer.render.apply(this,arguments);}});sap.m.Link.extend("sap.suite.ui.commons.TargetFilterLink",{metadata:{properties:{count:{type:"sap.ui.core/int"}}},renderer:function(r,c){sap.m.LinkRenderer.render.apply(this,arguments);}});sap.ui.core.Control.extend("sap.suite.ui.commons.TargetFilterLinksCloud",{metadata:{properties:{index:{type:"sap.ui.core/int"}},aggregations:{links:{cardinality:"0..n",type:"sap.suite.ui.commons.TargetFilterLink"}}},_setFontSizes:function(l){var L=["Largest","Large","Medium","Small","Smallest"];var O=jQuery.unique(l.map(function(o){return o.getCount();}));switch(O.length){case 1:for(var b=0;b<l.length;b++){l[b].addStyleClass(L[2]);}break;case 2:for(var b=0;b<l.length;b++){if(O[0]==l[b].getCount()){l[b].addStyleClass(L[1]);}else{l[b].addStyleClass(L[3]);}}break;default:var i=Math.min.apply(null,O);var a=Math.max.apply(null,O);for(var b=0;b<l.length;b++){var s=Math.floor(4.99*(a-l[b].getCount())/(a-i));l[b].addStyleClass(L[s]);}}},renderer:function(r,c){var t=c.getParent();var l=c.getLinks();r.write("<div");r.writeControlData(c);r.addClass("sapSuiteUiTFLinksCloud");r.writeClasses();r.write(">");c._setFontSizes(l);for(var i=0;i<l.length;i++){if(!t._oFilters[l[i].getText()]){l[i].addStyleClass("Unselected");}r.renderControl(l[i]);}r.write("</div>");},updateDirtyFlag:function(){var t=this.getParent();if(Object.getOwnPropertyNames(t._oFilters).length){this.$().addClass("Dirty");}else{this.$().removeClass("Dirty");}},onAfterRendering:function(){this.drawCloudCircle();this.updateDirtyFlag();},calculateBgSquare:function(){var s=0;for(var i=0;i<this._bgArea.length;i++){var w=this._bgArea[i].width;s+=(w>0)?w:0;}return s;},calculateLinesSquare:function(l){var s=0;l.each(function(){var L=jQuery(this);s+=(1+parseInt(L.outerWidth(true))*parseInt(L.outerHeight(true)));});return s;},drawCloudCircle:function(){var o=parseInt(jQuery(".sapSuiteUiTFOuterCircle").outerWidth(true)/2)-3;var c=parseInt(jQuery(".sapSuiteUiTFCentralCircle").outerWidth(true)/2)+3;var v=parseInt(jQuery(".sapSuiteUiTFOuterCont").outerHeight(true)/2);var i=jQuery("html").hasClass("sapUiMedia-Std-Phone");var b=parseInt(jQuery(".sapSuiteUiTFParCont").outerHeight(true));var B=90;if(i){v=200;B=200;}this.initQuadArea(o-16,v-16,c+16,b+16,B+16,16);var t=this;var q=this.getIndex();var p;var l=jQuery(".sapSuiteUiTFLine.Quad"+q);if(l.length!=0){var L=jQuery(".sapSuiteUiTFOthersLine.Quad"+q);var a=L.length!==0;var d=this.calculateBgSquare();var e=this.calculateLinesSquare(l);var s=d/e;var Q=3;do{p=[];if(a){if(q<=1){var P=t.findPlacements(parseInt(L.outerWidth(true)),parseInt(L.outerHeight(true)));p.push(t.placeLine(L,P[0],q,true,o));}else{var P=t.findPlacements(parseInt(L.outerWidth(true)),parseInt(L.outerHeight(true)));p.push(t.placeLine(L,P[P.length-1],q,true,o));}}var V=true;l.each(function(){var h=jQuery(this);if(!V){h.addClass("Hidden");return;}var r=parseInt(h.outerWidth(true))+1;if(s<.9){var j=false;var F=true;var k=r;do{var P=t.findPlacements(k,parseInt(h.outerHeight(true)));var A=Math.min(P.length,10);while(A-->0){var m=t.placeLine(h,P[Math.floor(Math.random()*P.length)],1+q,false,o);if(!t.isIntersecting(m,p)){p.push(m);j=true;break;}}if(!j&&F){k-=parseInt(k*s);}F=false;}while(!j&&(k--)>parseInt(h.css("min-width")));if(!j){V=false;}if(!V){h.addClass("Hidden");}}else{var P=t.findPlacements(r,parseInt(h.outerHeight(true)));var A=Math.min(P.length,10);while(A-->0){var m=t.placeLine(h,P[Math.floor(Math.random()*P.length)],1+q,false,o);if(!t.isIntersecting(m,p)){p.push(m);break;}}}});}while(l.length+(a?1:0)>p.length&&Q-->0);for(var f=0;f<p.length;f++){var g=p[f].line;g.css("top",""+p[f].y1+"px");g.css("left",""+p[f].x1+"px");g.outerWidth(""+p[f].lineWidth+"px");}}},isIntersecting:function(p,P){for(var i=0;i<P.length;i++){if(Math.max(0,Math.min(p.x2,P[i].x2)-Math.max(p.x1,P[i].x1))*Math.max(0,Math.min(p.y2,P[i].y2)-Math.max(p.y1,P[i].y1))>0){return true;}}return false;},initQuadArea:function(o,v,I,b,B,a){var c=jQuery("html").hasClass("sapUiMedia-Std-Phone");this._bgArea=new Array(v);for(var i=0;i<=v;i++){this._bgArea[i]={start:a,width:parseInt(Math.sqrt(o*o-i*i))};if(i<=I){this._bgArea[i].start=parseInt(Math.sqrt(I*I-i*i));this._bgArea[i].width-=this._bgArea[i].start;}if(i<=a){this._bgArea[i].width=0;}if(i<=b){this._bgArea[i].width-=B;}else{if(c){this._bgArea[i].width=Math.min(this._bgArea[i].width,160);}}}},findPlacements:function(w,h){var p=[];var b=this._bgArea.length;for(var i=0;i<=b-h;i++){var m=0;var M=this._bgArea[i].width;var c=true;for(var j=i;j<i+h;j++){var B=this._bgArea[j];if(w>B.width){c=false;break;}if(B.start>m){m=B.start;}if(B.width<M){M=B.width;}}if(c){p.push({x:m,y:i,lineWidth:w,availableWidth:M});}}return p;},placeLine:function(l,p,q,c,r){var x=Math.floor((p.availableWidth-p.lineWidth)*(c?.5:Math.random()));var X=p.x+x;var y=p.y;if(q==4){X=r+X;y=r+y;}else if(q==1){X=r+X;y=r-y-l.outerHeight(true);}else if(q==2){X=r-X-p.lineWidth;y=r-y-l.outerHeight(true);}else{X=r-X-p.lineWidth;y=r+y;}return{x1:X,x2:X+p.lineWidth,y1:y,y2:y+l.outerHeight(true),lineWidth:p.lineWidth,line:l};}});sap.ui.core.Control.extend("sap.suite.ui.commons.TargetFilterQuadrant",{metadata:{properties:{index:{type:"sap.ui.core/int"}},aggregations:{linkClouds:{cardinality:"0..n",type:"sap.suite.ui.commons.TargetFilterLinksCloud"}}},init:function(){var t=this;this._oFilterCb=new sap.suite.ui.commons.TargetFilterComboBox(this.getId()+"-cb",{selectionChange:function(){t.setColumn(this.getSelectedKey(),true);},});this._oValueHelpBtn=new sap.m.Button(this.getId()+"-btn",{icon:"sap-icon://value-help",press:function(){t.fnShowValueHelper();}});this.addLinkCloud(new sap.suite.ui.commons.TargetFilterLinksCloud(this.getId()+"-links"));},setProperty:function(p,v,s){sap.ui.core.Element.prototype.setProperty.apply(this,arguments);if(p==="index"){if(v==0||v==1){this._oFilterCb.setPopoverPlacement(sap.m.PlacementType.VerticalPreferedTop).addStyleClass("sapSuiteTFCBTop");}else{this._oFilterCb.setPopoverPlacement(sap.m.PlacementType.VerticalPreferedBottom);}if(v==0||v==3){this._oFilterCb.addStyleClass("sapSuiteTFCBArrowBeforeVal");}this.getLinkClouds()[0].setIndex(v);}},setColumn:function(c,d){this._oColumn=sap.ui.getCore().byId(c);if(this._oColumn){this._oFilters={};if(!d){this._oFilterCb.setSelectedKey(c);}var t=this.getParent();var a=this;var r=new sap.suite.ui.commons.TargetFilterLink({text:"{"+this._oColumn.getName()+"}",count:"{"+t.getMeasureColumnName()+"}",press:function(e){if(a._oFilters[this.getText()]){delete a._oFilters[this.getText()];this.$().addClass("Unselected");}else{a._oFilters[this.getText()]=new sap.ui.model.Filter(a._oColumn.getName(),sap.ui.model.FilterOperator.EQ,this.getText());this.$().removeClass("Unselected");}a.getLinkClouds()[0].updateDirtyFlag();}});r.addStyleClass("sapSuiteUiTFLine");r.addStyleClass("Quad"+this.getIndex());this.getLinkClouds()[0].bindAggregation("links",{path:"/"+t.getEntitySet(),parameters:{select:this._oColumn.getName()+","+t.getMeasureColumnName()},template:r,length:25,sorter:[new sap.ui.model.Sorter(t.getMeasureColumnName(),true),new sap.ui.model.Sorter(this._oColumn.getName(),false)]});}else{this.getLinkClouds()[0].removeAllLinks();}},fnShowValueHelper:function(){var t=this.getParent();var i=new sap.m.StandardListItem({title:"{"+this._oColumn.getName()+"}",description:{path:t.getMeasureColumnName(),formatter:function(n){return"Entries "+n}},});t._oSelectDialog.bindAggregation("items",{path:"/"+t.getEntitySet(),parameters:{select:this._oColumn.getName()+","+t.getMeasureColumnName()},sorter:[new sap.ui.model.Sorter(t.getMeasureColumnName(),true),new sap.ui.model.Sorter(this._oColumn.getName(),false)],template:i});t._oSelectDialog._oColumn=this._oColumn;t._oSelectDialog.setTitle(this._oColumn.getTitle()),t._oSelectDialog.open();},rebindColumns:function(){var t=this.getParent();this._oFilterCb.removeAllItems();for(var i=0;i<t.getColumns().length;i++){var c=t.getColumns()[i];var I=new sap.ui.core.Item({key:c.getId(),text:c.getTitle()});this._oFilterCb.addItem(I);}if(t.getSelectedColumns()&&t.getSelectedColumns()[this.getIndex()]){this.setColumn(t.getSelectedColumns()[this.getIndex()]);}else if(t.getColumns()[this.getIndex()]){this.setColumn(t.getColumns()[this.getIndex()].getId());}else{this.setColumn();}},exit:function(){this._oFilterCb.destroy();this._oValueHelpBtn.destroy();},renderer:function(r,c){r.write("<div");r.writeControlData(c);r.addClass("sapSuiteUiTFQuadrant");r.addClass("Quad"+c.getIndex());r.writeClasses();r.write(">");r.write("<div");r.addClass("sapSuiteUiTFParCont");r.addClass("Quad"+c.getIndex());r.writeClasses();r.write(">");r.renderControl(c._oFilterCb);r.write("</div>");r.write("<div");r.addClass("sapSuiteUiTFValHel");r.addClass("Quad"+c.getIndex());r.writeClasses();r.write(">");r.renderControl(c._oValueHelpBtn);r.write("</div>");r.renderControl(c.getLinkClouds()[0]);r.write("</div>");}});sap.ui.core.Control.extend("sap.suite.ui.commons.TargetFilterCountDisplay",{metadata:{aggregations:{counts:{cardinality:"0..n",type:"sap.suite.ui.commons.TargetFilterCount"}}},renderer:function(r,c){r.write("<div");r.writeControlData(c);r.addClass("sapSuiteUiTFCentralLabel");r.writeClasses();r.write(">");if(c.getCounts().length){r.write(c.getCounts()[0].getCount());}r.write("</div>");}});sap.ui.core.Element.extend("sap.suite.ui.commons.TargetFilterCount",{metadata:{properties:{count:{type:"sap.ui.core/int"}},events:{countUpdated:{}}},setProperty:function(p,v,s){sap.ui.core.Element.prototype.setProperty.apply(this,arguments);if(p==="count"){this.fireCountUpdated({});}}});
sap.suite.ui.commons.TargetFilter.prototype.init=function(){sap.ui.Device.media.attachHandler(this.rerender,this,sap.ui.Device.media.RANGESETS.SAP_STANDARD);var t=this;this._aQudrants=[];for(var i=0;i<4;i++){var q=new sap.suite.ui.commons.TargetFilterQuadrant(this.getId()+"-quad"+i,{index:i});this._aQudrants.push(q);this.setAggregation("_quad"+i,q);}this._oSearchBtn=new sap.m.Button(this.getId()+"-search",{icon:"sap-icon://initiative",press:function(){}}).addStyleClass("sapSuiteUiTFSearchBtn");this._oSettingsBtn=new sap.m.Button(this.getId()+"-master-settings-button",{icon:"sap-icon://action-settings"});this._oSearchFieldLbl=new sap.m.Label(this.getId()+"-search-field-label",{text:"Search other keyword",labelFor:this.getId()+"-search-field"});this._oSearchField=new sap.m.SearchField(this.getId()+"-search-field");this._oSelLstLbl=new sap.m.Label(this.getId()+"-selection-list-label",{text:"Your selection",labelFor:this.getId()+"-selection-list"});this._oSelLst=new sap.m.List(this.getId()+"-selection-list",{mode:"Delete","delete":this.fnHandleDelete,enableBusyIndicator:true,showSeparators:"None",growing:true});this._oScrollCont=new sap.m.ScrollContainer(this.getId()+"-scrl-cntnr",{width:"14.5rem",horizontal:false,vertical:true,height:"17rem",content:this._oSelLst});this._oShowSelLbl=new sap.m.Link(this.getId()+"-show-selected-label").addStyleClass("sapSuiteUiTFShowSelLbl");this._oShowSelBox=new sap.m.HBox(this.getId()+"-selection-box",{items:[this._oShowSelLbl,this._oSearchBtn]}).addStyleClass("sapSuiteUiTFShowSelBox");this._oRightPanel=new sap.m.VBox(this.getId()+"-right-panel",{items:[this._oSearchFieldLbl,this._oSearchField,this._oSelLstLbl,this._oScrollCont,this._oShowSelBox]});this._oSelectDialog=new sap.m.SelectDialog({multiSelect:true,liveChange:function(e){var f=[];var s=e.getParameter("value");var a=e.getParameter("itemsBinding");if(s!==undefined&&s.length){f.push(new sap.ui.model.Filter(this._oColumn.getName(),sap.ui.model.FilterOperator.EQ,s));}a.filter(f);}});this.setAggregation("_dialog",this._oSelectDialog);this._oCountDisplay=new sap.suite.ui.commons.TargetFilterCountDisplay();this.setAggregation("_countDisplay",this._oCountDisplay);};
sap.suite.ui.commons.TargetFilter.prototype._bindModel=function(){if(this._bBindModel){this._bBindModel=false;for(var i=0;i<this._aQudrants.length;i++){this._aQudrants[i].rebindColumns();}var t=this;this._oCountDisplay.bindAggregation("counts",{path:"/"+this.getEntitySet(),parameters:{select:this.getMeasureColumnName()},length:1,template:new sap.suite.ui.commons.TargetFilterCount({count:"{"+this.getMeasureColumnName()+"}",countUpdated:function(){t._oShowSelLbl.setText("Show selected "+this.getCount());}})});}};
sap.suite.ui.commons.TargetFilter.prototype._callMethodInManagedObject=function(f,e){if(e==="columns"||e==="entitySet"||e==="measureColumnName"){this._bBindModel=true;}var a=Array.prototype.slice.call(arguments);return sap.ui.core.Control.prototype[f].apply(this,a.slice(1));};
sap.suite.ui.commons.TargetFilter.prototype.setProperty=function(p,v,s){this._callMethodInManagedObject("setProperty",p,v,s);return this;};
sap.suite.ui.commons.TargetFilter.prototype.insertAggregation=function(a,o,i,s){this._callMethodInManagedObject("insertAggregation",a,o,i,s);return this;};
sap.suite.ui.commons.TargetFilter.prototype.addAggregation=function(a,o,s){this._callMethodInManagedObject("addAggregation",a,o,s);return this;};
sap.suite.ui.commons.TargetFilter.prototype.removeAggregation=function(a,o,s){return this._callMethodInManagedObject("removeAggregation",a,o,s);};
sap.suite.ui.commons.TargetFilter.prototype.removeAllAggregation=function(a,s){return this._callMethodInManagedObject("removeAllAggregation",a,s);};
sap.suite.ui.commons.TargetFilter.prototype.destroyAggregation=function(a,s){this._callMethodInManagedObject("destroyAggregation",a,s);return this;};
sap.suite.ui.commons.TargetFilter.prototype.fnHandleDelete=function(e){var l=e.getSource();l.attachEventOnce("updateFinished",l.focus,l);l.removeItem(e.getParameter("listItem"));l.rerender();};
sap.suite.ui.commons.TargetFilter.prototype.onBeforeRendering=function(){this._bindModel();};
sap.suite.ui.commons.TargetFilter.prototype.exit=function(){sap.ui.Device.media.detachHandler(this.rerender,this,sap.ui.Device.media.RANGESETS.SAP_STANDARD);this._oSearchBtn.destroy();this._oSettingsBtn.destroy();this._oSearchFieldLbl.destroy();this._oSearchField.destroy();this._oSelLstLbl.destroy();this._oSelLst.destroy();this._oScrollCont.destroy();this._oShowSelLbl.destroy();this._oShowSelBox.destroy();this._oRightPanel.destroy();};
